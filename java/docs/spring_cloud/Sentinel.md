# Sentinel

`Sentinel`是阿里巴巴开源的一个用于保护微服务架构的流量控制组件，
主要以流量为切入点，从流量控制、熔断降级、系统负载保护等多个维度来帮助您提升微服务架构的稳定性。

`Sentinel`的设计目标是简单易用，可以无缝集成到`Spring Cloud`、`Dubbo`等微服务框架中，同时也支持独立使用。
它适用于各种微服务架构，无论是单体应用还是复杂的分布式系统，都能提供有效的流量管理和保护策略。

代码仓库：https://github.com/alibaba/Sentinel
文档地址：https://sentinelguard.io/zh-cn/docs/introduction.html

## `Sentinel`代码模块

- `sentinel-adapter`：适配器模块，主要实现了对一些常见框架的适配
- `sentinel-benchmark`：基准测试模块，对核心代码的精确性提供基准测试
- `sentinel-cluster`：集群流控制模块，默认实现。
  - `sentinel-cluster-common-default`：用于集群传输和功能的通用模块 
  - `sentinel-cluster-client-default`：使用`Netty`作为底层传输库的默认集群客户端模块 
  - `sentinel-cluster-server-default`：默认集群服务器模块
- `sentinel-core`：核心模块，限流、降级、系统保护等都在这里实现
- `sentinel-dashboard`：控制台模块，可以对连接上的`sentinel`客户端实现可视化的管理
- `sentinel-demo`：示例模块，可参考怎么使用`sentinel`进行限流、降级等
- `sentinel-extension`：扩展模块，主要对`DataSource`进行了部分扩展实现
- `sentinel-logging`：日志模块，提供了日志输出的接口，以及一些默认实现
- `sentinel-transport`：传输模块，提供了基本的监控服务端和客户端的API接口，以及一些基于不同库的实现

## `Sentinel`提供了以下核心功能

- 流量控制: `Sentinel`可以基于资源、`URL`或者自定义规则进行限流，支持`QPS`和线程数两种限流方式，以及冷启动和预热机制。
- 熔断降级: 当下游服务出现异常或者响应时间过长时，`Sentinel`可以进行熔断，快速返回错误信息，避免雪崩效应。
- 系统保护: `Sentinel`可以根据系统的负载情况，比如线程池使用率、`CPU`使用率、入口`QPS`等指标，对整个系统进行保护，避免系统过载。
- 集群限流: `Sentinel`支持跨应用的集群限流，可以确保整个集群的稳定运行。
- 动态规则管理: `Sentinel`支持动态调整规则，无需重启应用即可生效，方便运维和管理。
- `Dashboard`: `Sentinel`提供了一个可视化的控制台，可以实时监控服务的运行状态和流量情况，并且可以动态调整规则。

## `Sentinel`的一些特性

### 流量控制

`Sentinel`提供丰富的流量控制策略，例如`QPS`（每秒查询率）限制、并发线程数限制。
支持基于请求来源的限流，可以对不同来源的请求分别进行流量控制。
支持预热模式，防止因系统启动时流量冲击导致的系统崩溃。

### 熔断降级

`Sentinel`支持异常数、异常比例和慢调用比例等多种降级策略。
提供触发熔断的条件配置，自动切断异常服务的请求，保护系统不发生雪崩效应。

### 热点参数限流

对频繁访问的热点数据进行参数级别的限流，更加精细化管理流量。
可以针对`API`中的特定“热点”参数进行流量控制，能够处理诸如`秒杀`场景下的热点限流问题。

### 系统保护

`Sentinel`可自适应地保护系统，当系统负载达到设定阈值时，会限制入口流量保护系统稳定。
通过监控系统负载情况，如`CPU`过高则自动进行流量控制。

### 实时监控和管理

`Sentinel`提供实时监控控制台，可视化显示监控信息并实时配置规则。
提供实时监控数据查看和机器发现的功能，方便用户进行系统调优管理。

### 集群流量控制

支持集群模式下的流量控制，能够在集群中统一管理和协调流量。
支持集群内流量分摊和重定向，以及灵活的流量分配策略。

### 开放扩展性

`Sentinel`提供扩展点，支持自定义限流器、降级器等。
支持与其它开源框架与类库的集成，如与`Spring Cloud`、`Dubbo`等深度集成。

### 动态规则配置

支持动态修改流控和降级规则，无需重启服务即可热更新规则。

### 异步请求支持

对异步请求提供等待队列时间设置，使得异步请求也能实现流量控制。

## `Sentinel`和`Hystrix`不同

`Sentinel`和`Hystrix`都是用于管理分布式系统中的服务可靠性和延迟容忍性的工具，它们提供了像熔断器、限流器和服务降级这样的功能。
虽然两者的目标类似，但它们在实现和功能上存在一些差异。

- 模块化与可扩展性
  - `Sentinel`：具有更模块化的设计，提供了更丰富的扩展点，易于个性化和扩展定制。
  - `Hystrix`：作为`Netflix OSS`套件的一部分，主要集成到`Spring Cloud Netflix`中，提供较固定的模式。
- 流量控制能力
  - `Sentinel`：专注于流量控制，包括限流、熔断、系统过载保护（通过系统负载来保护服务）、以及流量整形（调整流量分配）等。
  - `Hystrix`：主要是提供熔断器和线程隔离策略，用于隔离和管理故障。
- 控制台和监控
  - `Sentinel`：提供一个功能丰富的控制台，用于实时监控和操作规则配置调整。
  - `Hystrix`：提供了`Hystrix Dashboard`和`Turbine`，用于聚合和展示服务的指标。
- 性能表现
  - `Sentinel`：由于其轻量级的设计，对性能影响较小，适用于高并发场景。
  - `Hystrix`：由于其设计采用线程隔离，在高并发下可能因线程池的限制而对性能产生影响。
- 社区支持和维护状态
  - `Sentinel`：由阿里巴巴维护，并作为`Spring Cloud Alibaba`的一部分继续得到更新和支持。
  - `Hystrix`：自2018年起，进入维护模式，`Netflix`不再积极开发新特性。`Spring Cloud`项目也逐渐替换为其他替代方案，如`Resilience4j`。
- 易用性与配置
  - `Sentinel`：配置方式简单直观，容易入门，且规则配置的灵活性较高。
  - `Hystrix`：虽然与`Spring Cloud`集成得比较紧密，但学习曲线相对陡峭，配置项相对复杂。
- 异步编程模型
  - `Sentinel`：它天然支持响应式和异步编程模型。
  - `Hystrix`：虽然提供了对异步执行的支持，但更多的是以同步方式执行。
- 链路追踪与日志
  - `Sentinel`：针对链路入口和出口的流量，提供比较细粒度的流量追踪和记录。
  - `Hystrix`：提供了执行事件的日志功能，但相对较粗。

目前国内主流是使用`Sentinel`的。

## Sentinel流量控制

`Sentinel`实现流量控制的机制涉及以下几个主要方面：

- 资源定义
  - 确定需要保护的资源。在`Sentinel`中，资源可以是`HTTP`接口、`Dubbo`接口、某个微服务或一段代码。开发者需要明确资源的资源名，通常作为流量控制的标识。
- 流量控制规则配置
  - 配置对应资源的流量控制规则，规则包括规则类型（例如`QPS`或线程数）、阈值、流量控制效果（例如直接拒绝、排队等候或预热/冷却）和流量控制行为（根据调用关系、`QPS`还是线程数等）。
- 资源访问入口
  - 在代码中定义资源访问入口。`Sentinel`利用细粒度的统计来接入和监控应用的不同流量类型，你需要使用`Sentinel`提供的`API`来定义资源的开始和结束。
    ```java 
    try (Entry entry = SphU.entry("resourceName")) { 
        // 受保护的资源逻辑
    } catch (BlockException e) {
        // 当流量控制规则触发时，处理控制行为
    }
    ```
- 流量控制检查
  - 每当资源被访问时，`Sentinel`会根据配置的规则来检查是否超出阈值。如果检查通过，则允许访问资源；如果失败，则根据配置的流控效果来执行相应操作。
- 自适应控制
  - `Sentinel`支持自适应流控策略，可以根据系统的实际负载（比如系统负载、`CPU`使用率等）来动态调整流量。
- 实时监控
  - `Sentinel`提供监控功能，可以在`Sentinel Dashboard`实时监控资源的运行状态，查看流量、通过量、阻塞量等指标。

## 流量控制策略

`Sentinel`的流量控制是非常灵活的，支持多种控制策略（比如直接拒绝调用、排队等待、按照调用链路入口控制等），并且可以与服务之间的调用链路整合，实现服务间的流量协同。

通过合理设置规则和参数，`Sentinel`配置的流控规则可以应对不同的流量控制场景，并配合其他功能（比如熔断降级、系统自适应保护）实现更加全面的服务保护。

- 流量阀值限流（Flow Rule Limiting）
  - `Sentinel`中最常用的限流方式，它通过配置流量的阀值来控制流量。可以设置`QPS`（每秒查询率）或线程数阈值。
  - 到达阀值时，`Sentinel`将根据预定义的流控效果（快速失败、预热、排队等待）来处理后续请求。
- 关联限流
  - 关联限流（也称为关联流量控制）用于控制当关联资源过载时对当前资源执行限流。例如，当下游服务已接近其负载极限时，可以减少对上游服务的请求。
- 链路限流（Chain-based Throttling）
  - 链路限流允许你只对特定来源的流量执行限流。该策略可用于微服务场景中，只对来自特定微服务的请求进行限流。
- 热点参数限流
  - 热点参数限流允许根据请求中的热点参数（例如，在系统中的某业务`ID`）进行精细化控制。它通过排队来限制频繁访问特定资源的请求。
- 系统自适应保护
  - 根据系统的负载（比如系统负载、`CPU`使用率、平均`RT`）对流量进行动态的限流，以此来保护系统不被高流量击垮。
- 流量控制效果
  - 在限流策略中，`Sentinel`支持几种不同的流量控制效果，包括快速失败、`Warm Up`（预热/冷启动）、排队等待/匀速排队等。
    - 快速失败：直接对超出阈值的请求快速失败。
    - `Warm Up`：渐进地提高通过量，用于应对系统冷启动。
    - 排队等待/匀速排队：使请求以匀速排队的方式处理，减缓突增流量带来的冲击。
- 实时监控和动态规则更新
  - `Sentinel`提供实时监控和动态规则更新的能力。控制台，可以实时监控流量情况，并且在运行时动态调整限流规则。
- `API`和注解支持
  - 还提供了丰富的`API`接口和相关注解，方便在代码中定义规则和限流逻辑。

要执行`Sentinel`的限流策略，需要在控制台或通过`API`设置相应的规则，这些规则根据运行时的监控数据动态调整。
这样使得微服务可以根据系统当前的状态和策略来保护自己，并确保系统的稳定性和可靠性。

通过`Sentinel`的限流机制，可以在不影响系统整体稳定性的前提下，处理高流量压力和潜在的过载风险。
